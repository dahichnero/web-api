<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>text.html</title>
  <meta name="generator" content="Haroopad 0.13.1" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>div.oembedall-githubrepos{border:1px solid #DDD;border-radius:4px;list-style-type:none;margin:0 0 10px;padding:8px 10px 0;font:13.34px/1.4 helvetica,arial,freesans,clean,sans-serif;width:452px;background-color:#fff}div.oembedall-githubrepos .oembedall-body{background:-moz-linear-gradient(center top,#FAFAFA,#EFEFEF);background:-webkit-gradient(linear,left top,left bottom,from(#FAFAFA),to(#EFEFEF));border-bottom-left-radius:4px;border-bottom-right-radius:4px;border-top:1px solid #EEE;margin-left:-10px;margin-top:8px;padding:5px 10px;width:100%}div.oembedall-githubrepos h3{font-size:14px;margin:0;padding-left:18px;white-space:nowrap}div.oembedall-githubrepos p.oembedall-description{color:#444;font-size:12px;margin:0 0 3px}div.oembedall-githubrepos p.oembedall-updated-at{color:#888;font-size:11px;margin:0}div.oembedall-githubrepos ul.oembedall-repo-stats{border:none;float:right;font-size:11px;font-weight:700;padding-left:15px;position:relative;z-index:5;margin:0}div.oembedall-githubrepos ul.oembedall-repo-stats li{border:none;color:#666;display:inline-block;list-style-type:none;margin:0!important}div.oembedall-githubrepos ul.oembedall-repo-stats li a{background-color:transparent;border:none;color:#666!important;background-position:5px -2px;background-repeat:no-repeat;border-left:1px solid #DDD;display:inline-block;height:21px;line-height:21px;padding:0 5px 0 23px}div.oembedall-githubrepos ul.oembedall-repo-stats li:first-child a{border-left:medium none;margin-right:-3px}div.oembedall-githubrepos ul.oembedall-repo-stats li a:hover{background:5px -27px no-repeat #4183C4;color:#FFF!important;text-decoration:none}div.oembedall-githubrepos ul.oembedall-repo-stats li:first-child a:hover{border-bottom-left-radius:3px;border-top-left-radius:3px}ul.oembedall-repo-stats li:last-child a:hover{border-bottom-right-radius:3px;border-top-right-radius:3px}span.oembedall-closehide{background-color:#aaa;border-radius:2px;cursor:pointer;margin-right:3px}div.oembedall-container{margin-top:5px;text-align:left}.oembedall-ljuser{font-weight:700}.oembedall-ljuser img{vertical-align:bottom;border:0;padding-right:1px}.oembedall-stoqembed{border-bottom:1px dotted #999;float:left;overflow:hidden;width:730px;line-height:1;background:#FFF;color:#000;font-family:Arial,Liberation Sans,DejaVu Sans,sans-serif;font-size:80%;text-align:left;margin:0;padding:0}.oembedall-stoqembed a{color:#07C;text-decoration:none;margin:0;padding:0}.oembedall-stoqembed a:hover{text-decoration:underline}.oembedall-stoqembed a:visited{color:#4A6B82}.oembedall-stoqembed h3{font-family:Trebuchet MS,Liberation Sans,DejaVu Sans,sans-serif;font-size:130%;font-weight:700;margin:0;padding:0}.oembedall-stoqembed .oembedall-reputation-score{color:#444;font-size:120%;font-weight:700;margin-right:2px}.oembedall-stoqembed .oembedall-user-info{height:35px;width:185px}.oembedall-stoqembed .oembedall-user-info .oembedall-user-gravatar32{float:left;height:32px;width:32px}.oembedall-stoqembed .oembedall-user-info .oembedall-user-details{float:left;margin-left:5px;overflow:hidden;white-space:nowrap;width:145px}.oembedall-stoqembed .oembedall-question-hyperlink{font-weight:700}.oembedall-stoqembed .oembedall-stats{background:#EEE;margin:0 0 0 7px;padding:4px 7px 6px;width:58px}.oembedall-stoqembed .oembedall-statscontainer{float:left;margin-right:8px;width:86px}.oembedall-stoqembed .oembedall-votes{color:#555;padding:0 0 7px;text-align:center}.oembedall-stoqembed .oembedall-vote-count-post{font-size:240%;color:#808185;display:block;font-weight:700}.oembedall-stoqembed .oembedall-views{color:#999;padding-top:4px;text-align:center}.oembedall-stoqembed .oembedall-status{margin-top:-3px;padding:4px 0;text-align:center;background:#75845C;color:#FFF}.oembedall-stoqembed .oembedall-status strong{color:#FFF;display:block;font-size:140%}.oembedall-stoqembed .oembedall-summary{float:left;width:635px}.oembedall-stoqembed .oembedall-excerpt{line-height:1.2;margin:0;padding:0 0 5px}.oembedall-stoqembed .oembedall-tags{float:left;line-height:18px}.oembedall-stoqembed .oembedall-tags a:hover{text-decoration:none}.oembedall-stoqembed .oembedall-post-tag{background-color:#E0EAF1;border-bottom:1px solid #3E6D8E;border-right:1px solid #7F9FB6;color:#3E6D8E;font-size:90%;line-height:2.4;margin:2px 2px 2px 0;padding:3px 4px;text-decoration:none;white-space:nowrap}.oembedall-stoqembed .oembedall-post-tag:hover{background-color:#3E6D8E;border-bottom:1px solid #37607D;border-right:1px solid #37607D;color:#E0EAF1}.oembedall-stoqembed .oembedall-fr{float:right}.oembedall-stoqembed .oembedall-statsarrow{background-image:url(http://cdn.sstatic.net/stackoverflow/img/sprites.png?v=3);background-repeat:no-repeat;overflow:hidden;background-position:0 -435px;float:right;height:13px;margin-top:12px;width:7px}.oembedall-facebook1{border:1px solid #1A3C6C;padding:0;font:13.34px/1.4 verdana;width:500px}.oembedall-facebook2{background-color:#627add}.oembedall-facebook2 a{color:#e8e8e8;text-decoration:none}.oembedall-facebookBody{background-color:#fff;vertical-align:top;padding:5px}.oembedall-facebookBody .contents{display:inline-block;width:100%}.oembedall-facebookBody div img{float:left;margin-right:5px}div.oembedall-lanyard{-webkit-box-shadow:none;-webkit-transition-delay:0s;-webkit-transition-duration:.4000000059604645s;-webkit-transition-property:width;-webkit-transition-timing-function:cubic-bezier(0.42,0,.58,1);background-attachment:scroll;background-clip:border-box;background-color:transparent;background-image:none;background-origin:padding-box;border-width:0;box-shadow:none;color:#112644;display:block;float:left;font-family:'Trebuchet MS',Trebuchet,sans-serif;font-size:16px;height:253px;line-height:19px;margin:0;max-width:none;min-height:0;outline:#112644 0;overflow-x:visible;overflow-y:visible;padding:0;position:relative;text-align:left;vertical-align:baseline;width:804px}div.oembedall-lanyard .tagline{font-size:1.5em}div.oembedall-lanyard .wrapper{overflow:hidden;clear:both}div.oembedall-lanyard .split{float:left;display:inline}div.oembedall-lanyard .prominent-place .flag:active,div.oembedall-lanyard .prominent-place .flag:focus,div.oembedall-lanyard .prominent-place .flag:hover,div.oembedall-lanyard .prominent-place .flag:link,div.oembedall-lanyard .prominent-place .flag:visited{float:left;display:block;width:48px;height:48px;position:relative;top:-5px;margin-right:10px}div.oembedall-lanyard .place-context{font-size:.889em}div.oembedall-lanyard .prominent-place .sub-place{display:block}div.oembedall-lanyard .prominent-place{font-size:1.125em;line-height:1.1em;font-weight:400}div.oembedall-lanyard .main-date{color:#8CB4E0;font-weight:700;line-height:1.1}div.oembedall-lanyard .first{width:48.57%;margin:0 0 0 2.857%}.mermaid .label{color:#333}.node circle,.node polygon,.node rect{fill:#cde498;stroke:#13540c;stroke-width:1px}.edgePath .path{stroke:green;stroke-width:1.5px}.cluster rect{fill:#cdffb2;rx:40;stroke:#6eaa49;stroke-width:1px}.cluster text{fill:#333}.actor{stroke:#13540c;fill:#cde498}text.actor{fill:#000;stroke:none}.actor-line{stroke:grey}.messageLine0{stroke-width:1.5;stroke-dasharray:"2 2";marker-end:"url(#arrowhead)";stroke:#333}.messageLine1{stroke-width:1.5;stroke-dasharray:"2 2";stroke:#333}#arrowhead{fill:#333}#crosshead path{fill:#333!important;stroke:#333!important}.messageText{fill:#333;stroke:none}.labelBox{stroke:#326932;fill:#cde498}.labelText,.loopText{fill:#000;stroke:none}.loopLine{stroke-width:2;stroke-dasharray:"2 2";marker-end:"url(#arrowhead)";stroke:#326932}.note{stroke:#6eaa49;fill:#fff5ad}.noteText{fill:#000;stroke:none;font-family:'trebuchet ms',verdana,arial;font-size:14px}.section{stroke:none;opacity:.2}.section0,.section2{fill:#6eaa49}.section1,.section3{fill:#fff;opacity:.2}.sectionTitle0,.sectionTitle1,.sectionTitle2,.sectionTitle3{fill:#333}.sectionTitle{text-anchor:start;font-size:11px;text-height:14px}.grid .tick{stroke:lightgrey;opacity:.3;shape-rendering:crispEdges}.grid path{stroke-width:0}.today{fill:none;stroke:red;stroke-width:2px}.task{stroke-width:2}.taskText{text-anchor:middle;font-size:11px}.taskTextOutsideRight{fill:#000;text-anchor:start;font-size:11px}.taskTextOutsideLeft{fill:#000;text-anchor:end;font-size:11px}.taskText0,.taskText1,.taskText2,.taskText3{fill:#fff}.task0,.task1,.task2,.task3{fill:#487e3a;stroke:#13540c}.taskTextOutside0,.taskTextOutside1,.taskTextOutside2,.taskTextOutside3{fill:#000}.active0,.active1,.active2,.active3{fill:#cde498;stroke:#13540c}.activeText0,.activeText1,.activeText2,.activeText3{fill:#000!important}.done0,.done1,.done2,.done3{stroke:grey;fill:lightgrey;stroke-width:2}.doneText0,.doneText1,.doneText2,.doneText3{fill:#000!important}.crit0,.crit1,.crit2,.crit3{stroke:#f88;fill:red;stroke-width:2}.activeCrit0,.activeCrit1,.activeCrit2,.activeCrit3{stroke:#f88;fill:#cde498;stroke-width:2}.doneCrit0,.doneCrit1,.doneCrit2,.doneCrit3{stroke:#f88;fill:lightgrey;stroke-width:2;cursor:pointer;shape-rendering:crispEdges}.activeCritText0,.activeCritText1,.activeCritText2,.activeCritText3,.doneCritText0,.doneCritText1,.doneCritText2,.doneCritText3{fill:#000!important}.titleText{text-anchor:middle;font-size:18px;fill:#000}text{font-family:'trebuchet ms',verdana,arial;font-size:14px}html{height:100%}body{margin:0!important;padding:5px 20px 26px!important;background-color:#fff;font-family:"Lucida Grande","Segoe UI","Apple SD Gothic Neo","Malgun Gothic","Lucida Sans Unicode",Helvetica,Arial,sans-serif;font-size:.9em;overflow-x:hidden;overflow-y:auto}br,h1,h2,h3,h4,h5,h6{clear:both}hr.page{background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAYAAAAECAYAAACtBE5DAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBNYWNpbnRvc2giIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6OENDRjNBN0E2NTZBMTFFMEI3QjRBODM4NzJDMjlGNDgiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6OENDRjNBN0I2NTZBMTFFMEI3QjRBODM4NzJDMjlGNDgiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo4Q0NGM0E3ODY1NkExMUUwQjdCNEE4Mzg3MkMyOUY0OCIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo4Q0NGM0E3OTY1NkExMUUwQjdCNEE4Mzg3MkMyOUY0OCIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PqqezsUAAAAfSURBVHjaYmRABcYwBiM2QSA4y4hNEKYDQxAEAAIMAHNGAzhkPOlYAAAAAElFTkSuQmCC) repeat-x;border:0;height:3px;padding:0}hr.underscore{border-top-style:dashed!important}body >:first-child{margin-top:0!important}img.plugin{box-shadow:0 1px 3px rgba(0,0,0,.1);border-radius:3px}iframe{border:0}figure{-webkit-margin-before:0;-webkit-margin-after:0;-webkit-margin-start:0;-webkit-margin-end:0}kbd{border:1px solid #aaa;-moz-border-radius:2px;-webkit-border-radius:2px;border-radius:2px;-moz-box-shadow:1px 2px 2px #ddd;-webkit-box-shadow:1px 2px 2px #ddd;box-shadow:1px 2px 2px #ddd;background-color:#f9f9f9;background-image:-moz-linear-gradient(top,#eee,#f9f9f9,#eee);background-image:-o-linear-gradient(top,#eee,#f9f9f9,#eee);background-image:-webkit-linear-gradient(top,#eee,#f9f9f9,#eee);background-image:linear-gradient(top,#eee,#f9f9f9,#eee);padding:1px 3px;font-family:inherit;font-size:.85em}.oembeded .oembed_photo{display:inline-block}img[data-echo]{margin:25px 0;width:100px;height:100px;background:url(../img/ajax.gif) center center no-repeat #fff}.spinner{display:inline-block;width:10px;height:10px;margin-bottom:-.1em;border:2px solid rgba(0,0,0,.5);border-top-color:transparent;border-radius:100%;-webkit-animation:spin 1s infinite linear;animation:spin 1s infinite linear}.spinner:after{content:'';display:block;width:0;height:0;position:absolute;top:-6px;left:0;border:4px solid transparent;border-bottom-color:rgba(0,0,0,.5);-webkit-transform:rotate(45deg);transform:rotate(45deg)}@-webkit-keyframes spin{to{-webkit-transform:rotate(360deg)}}@keyframes spin{to{transform:rotate(360deg)}}p.toc{margin:0!important}p.toc ul{padding-left:10px}p.toc>ul{padding:10px;margin:0 10px;display:inline-block;border:1px solid #ededed;border-radius:5px}p.toc li,p.toc ul{list-style-type:none}p.toc li{width:100%;padding:0;overflow:hidden}p.toc li a::after{content:"."}p.toc li a:before{content:"• "}p.toc h5{text-transform:uppercase}p.toc .title{float:left;padding-right:3px}p.toc .number{margin:0;float:right;padding-left:3px;background:#fff;display:none}input.task-list-item{margin-left:-1.62em}.markdown{font-family:"Hiragino Sans GB","Microsoft YaHei",STHeiti,SimSun,"Lucida Grande","Lucida Sans Unicode","Lucida Sans",'Segoe UI',AppleSDGothicNeo-Medium,'Malgun Gothic',Verdana,Tahoma,sans-serif;padding:20px}.markdown a{text-decoration:none;vertical-align:baseline}.markdown a:hover{text-decoration:underline}.markdown h1{font-size:2.2em;font-weight:700;margin:1.5em 0 1em}.markdown h2{font-size:1.8em;font-weight:700;margin:1.275em 0 .85em}.markdown h3{font-size:1.6em;font-weight:700;margin:1.125em 0 .75em}.markdown h4{font-size:1.4em;font-weight:700;margin:.99em 0 .66em}.markdown h5{font-size:1.2em;font-weight:700;margin:.855em 0 .57em}.markdown h6{font-size:1em;font-weight:700;margin:.75em 0 .5em}.markdown h1+p,.markdown h1:first-child,.markdown h2+p,.markdown h2:first-child,.markdown h3+p,.markdown h3:first-child,.markdown h4+p,.markdown h4:first-child,.markdown h5+p,.markdown h5:first-child,.markdown h6+p,.markdown h6:first-child{margin-top:0}.markdown hr{border:1px solid #ccc}.markdown p{margin:1em 0;word-wrap:break-word}.markdown ol{list-style-type:decimal}.markdown li{display:list-item;line-height:1.4em}.markdown blockquote{margin:1em 20px}.markdown blockquote>:first-child{margin-top:0}.markdown blockquote>:last-child{margin-bottom:0}.markdown blockquote cite:before{content:'\2014 \00A0'}.markdown .code{border-radius:3px;word-wrap:break-word}.markdown pre{border-radius:3px;word-wrap:break-word;border:1px solid #ccc;overflow:auto;padding:.5em}.markdown pre code{border:0;display:block}.markdown pre>code{font-family:Consolas,Inconsolata,Courier,monospace;font-weight:700;white-space:pre;margin:0}.markdown code{border-radius:3px;word-wrap:break-word;border:1px solid #ccc;padding:0 5px;margin:0 2px}.markdown img{max-width:100%}.markdown mark{color:#000;background-color:#fcf8e3}.markdown table{padding:0;border-collapse:collapse;border-spacing:0;margin-bottom:16px}.markdown table tr td,.markdown table tr th{border:1px solid #ccc;margin:0;padding:6px 13px}.markdown table tr th{font-weight:700}.markdown table tr th>:first-child{margin-top:0}.markdown table tr th>:last-child{margin-bottom:0}.markdown table tr td>:first-child{margin-top:0}.markdown table tr td>:last-child{margin-bottom:0}.github{padding:20px;font-family:"Helvetica Neue",Helvetica,"Hiragino Sans GB","Microsoft YaHei",STHeiti,SimSun,"Segoe UI",AppleSDGothicNeo-Medium,'Malgun Gothic',Arial,freesans,sans-serif;font-size:15px;background:#fff;line-height:1.6;-webkit-font-smoothing:antialiased}.github a{color:#3269a0}.github a:hover{color:#4183c4}.github h2{border-bottom:1px solid #e6e6e6;line-height:1.6}.github h6{color:#777}.github hr{border:1px solid #e6e6e6}.github pre>code{font-size:.9em;font-family:Consolas,Inconsolata,Courier,monospace}.github blockquote>code,.github h1>code,.github h2>code,.github h3>code,.github h4>code,.github h5>code,.github h6>code,.github li>code,.github p>code,.github td>code{background-color:rgba(0,0,0,.07);font-family:Consolas,"Liberation Mono",Menlo,Courier,monospace;font-size:85%;padding:.2em .5em;border:0}.github blockquote{border-left:4px solid #e6e6e6;padding:0 15px;font-style:italic}.github table{background-color:#fafafa}.github table tr td,.github table tr th{border:1px solid #e6e6e6}.github table tr:nth-child(2n){background-color:#f2f2f2}.hljs-comment{color:#969896}.css .hljs-class,.css .hljs-id,.css .hljs-pseudo,.hljs-attribute,.hljs-regexp,.hljs-tag,.hljs-variable,.html .hljs-doctype,.ruby .hljs-constant,.xml .hljs-doctype,.xml .hljs-pi,.xml .hljs-tag .hljs-title{color:#c66}.hljs-built_in,.hljs-constant,.hljs-literal,.hljs-number,.hljs-params,.hljs-pragma,.hljs-preprocessor{color:#de935f}.css .hljs-rules .hljs-attribute,.ruby .hljs-class .hljs-title{color:#f0c674}.hljs-header,.hljs-inheritance,.hljs-string,.hljs-value,.ruby .hljs-symbol,.xml .hljs-cdata{color:#b5bd68}.css .hljs-hexcolor,.hljs-title{color:#8abeb7}.coffeescript .hljs-title,.hljs-function,.javascript .hljs-title,.perl .hljs-sub,.python .hljs-decorator,.python .hljs-title,.ruby .hljs-function .hljs-title,.ruby .hljs-title .hljs-keyword{color:#81a2be}.hljs-keyword,.javascript .hljs-function{color:#b294bb}.hljs{display:block;overflow-x:auto;background:#1d1f21;color:#c5c8c6;padding:.5em;-webkit-text-size-adjust:none}.coffeescript .javascript,.javascript .xml,.tex .hljs-formula,.xml .css,.xml .hljs-cdata,.xml .javascript,.xml .vbscript{opacity:.5}.MathJax_Hover_Frame{border-radius:.25em;-webkit-border-radius:.25em;-moz-border-radius:.25em;-khtml-border-radius:.25em;box-shadow:0 0 15px #83A;-webkit-box-shadow:0 0 15px #83A;-moz-box-shadow:0 0 15px #83A;-khtml-box-shadow:0 0 15px #83A;border:1px solid #A6D!important;display:inline-block;position:absolute}.MathJax_Hover_Arrow{position:absolute;width:15px;height:11px;cursor:pointer}#MathJax_About{position:fixed;left:50%;width:auto;text-align:center;border:3px outset;padding:1em 2em;background-color:#DDD;color:#000;cursor:default;font-family:message-box;font-size:120%;font-style:normal;text-indent:0;text-transform:none;line-height:normal;letter-spacing:normal;word-spacing:normal;word-wrap:normal;white-space:nowrap;float:none;z-index:201;border-radius:15px;-webkit-border-radius:15px;-moz-border-radius:15px;-khtml-border-radius:15px;box-shadow:0 10px 20px gray;-webkit-box-shadow:0 10px 20px gray;-moz-box-shadow:0 10px 20px gray;-khtml-box-shadow:0 10px 20px gray;filter:progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}.MathJax_Menu{position:absolute;background-color:#fff;color:#000;width:auto;padding:2px;border:1px solid #CCC;margin:0;cursor:default;font:menu;text-align:left;text-indent:0;text-transform:none;line-height:normal;letter-spacing:normal;word-spacing:normal;word-wrap:normal;white-space:nowrap;float:none;z-index:201;box-shadow:0 10px 20px gray;-webkit-box-shadow:0 10px 20px gray;-moz-box-shadow:0 10px 20px gray;-khtml-box-shadow:0 10px 20px gray;filter:progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}.MathJax_MenuItem{padding:2px 2em;background:0 0}.MathJax_MenuArrow{position:absolute;right:.5em;color:#666}.MathJax_MenuActive .MathJax_MenuArrow{color:#fff}.MathJax_MenuArrow.RTL{left:.5em;right:auto}.MathJax_MenuCheck{position:absolute;left:.7em}.MathJax_MenuCheck.RTL{right:.7em;left:auto}.MathJax_MenuRadioCheck{position:absolute;left:1em}.MathJax_MenuRadioCheck.RTL{right:1em;left:auto}.MathJax_MenuLabel{padding:2px 2em 4px 1.33em;font-style:italic}.MathJax_MenuRule{border-top:1px solid #CCC;margin:4px 1px 0}.MathJax_MenuDisabled{color:GrayText}.MathJax_MenuActive{background-color:Highlight;color:HighlightText}.MathJax_Menu_Close{position:absolute;width:31px;height:31px;top:-15px;left:-15px}#MathJax_Zoom{position:absolute;background-color:#F0F0F0;overflow:auto;display:block;z-index:301;padding:.5em;border:1px solid #000;margin:0;font-weight:400;font-style:normal;text-align:left;text-indent:0;text-transform:none;line-height:normal;letter-spacing:normal;word-spacing:normal;word-wrap:normal;white-space:nowrap;float:none;box-shadow:5px 5px 15px #AAA;-webkit-box-shadow:5px 5px 15px #AAA;-moz-box-shadow:5px 5px 15px #AAA;-khtml-box-shadow:5px 5px 15px #AAA;filter:progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}#MathJax_ZoomOverlay{position:absolute;left:0;top:0;z-index:300;display:inline-block;width:100%;height:100%;border:0;padding:0;margin:0;background-color:#fff;opacity:0;filter:alpha(opacity=0)}#MathJax_ZoomFrame{position:relative;display:inline-block;height:0;width:0}#MathJax_ZoomEventTrap{position:absolute;left:0;top:0;z-index:302;display:inline-block;border:0;padding:0;margin:0;background-color:#fff;opacity:0;filter:alpha(opacity=0)}.MathJax_Preview{color:#888}#MathJax_Message{position:fixed;left:1px;bottom:2px;background-color:#E6E6E6;border:1px solid #959595;margin:0;padding:2px 8px;z-index:102;color:#000;font-size:80%;width:auto;white-space:nowrap}#MathJax_MSIE_Frame{position:absolute;top:0;left:0;width:0;z-index:101;border:0;margin:0;padding:0}.MathJax_Error{color:#C00;font-style:italic}footer{position:fixed;font-size:.8em;text-align:right;bottom:0;margin-left:-25px;height:20px;width:100%}</style>
</head>
<body class="markdown github">
<h1 id="создание-web-api"><a name="создание-web-api" href="#создание-web-api"></a>Создание Web Api</h1><p>Создадим простой Web Api. Основные возможности:</p><ul>
<li>аутентификация;</li><li>вывод списка товаров;</li><li>вывод списка категорий товаров;</li><li>добавление, изменение и удаление товаров и категорий;</li><li>создание заказа;</li><li>вывод списка заказов;</li></ul><h2 id="1.-создание-и-настройка-проекта"><a name="1.-создание-и-настройка-проекта" href="#1.-создание-и-настройка-проекта"></a>1. Создание и настройка проекта</h2><p>Создайте проект Web Api Asp.Net Core. Укажите “Использовать контроллеры” и “Поддержка OpenAPI”.</p><p>Удалите “WeatherForecast.cs” и “WeatherForecastController.cs”.</p><p>Установите пакеты Entity Framework Core для работы с Sqlite.</p><h2 id="2.-создание-контекста"><a name="2.-создание-контекста" href="#2.-создание-контекста"></a>2. Создание контекста</h2><p>Создайте папку Models.</p><p>Добавьте класс для продукта:</p><pre class="cs hljs"><code class="cs" data-origin="<pre><code class=&quot;cs&quot;>public class Product
{
    public int ProductId { get; set; }

    [StringLength(100)]
    public string Name { get; set; } = string.Empty;

    public string? Description { get; set; } = string.Empty;

    [StringLength(50)]
    public string? Photo { get; set; }

    public decimal Price { get; set; }

    public int CategoryId { get; set; }

    public Category Category { get; set; } = null!;

}
</code></pre>"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Product</span>
{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> ProductId { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }

    [StringLength(<span class="hljs-number">100</span>)]
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">string</span> Name { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; } = <span class="hljs-keyword">string</span>.Empty;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">string</span>? Description { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; } = <span class="hljs-keyword">string</span>.Empty;

    [StringLength(<span class="hljs-number">50</span>)]
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">string</span>? Photo { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">decimal</span> Price { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> CategoryId { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }

    <span class="hljs-keyword">public</span> Category Category { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; } = <span class="hljs-keyword">null</span>!;

}
</code></pre><p>Для категории:</p><pre class="cs hljs"><code class="cs" data-origin="<pre><code class=&quot;cs&quot;>public class Category
{
    public int CategoryId { get; set; }

    [StringLength(50)]
    public string Name { get; set; } = string.Empty;
}
</code></pre>"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Category</span>
{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> CategoryId { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }

    [StringLength(<span class="hljs-number">50</span>)]
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">string</span> Name { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; } = <span class="hljs-keyword">string</span>.Empty;
}
</code></pre><p>Для заказа:</p><pre class="cs hljs"><code class="cs" data-origin="<pre><code class=&quot;cs&quot;>public class Order
{
    public int OrderId { get; set; }

    public DateTime Time { get; set; }

    public IdentityUser&amp;lt;int&amp;gt; User { get; set; } = null!;
    public int UserId { get; set; }

    [StringLength(250)]
    public string Address { get; set; } = string.Empty;
}
</code></pre>"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Order</span>
{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> OrderId { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }

    <span class="hljs-keyword">public</span> DateTime Time { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }

    <span class="hljs-keyword">public</span> IdentityUser&lt;<span class="hljs-keyword">int</span>&gt; User { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; } = <span class="hljs-keyword">null</span>!;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> UserId { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }

    [StringLength(<span class="hljs-number">250</span>)]
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">string</span> Address { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; } = <span class="hljs-keyword">string</span>.Empty;
}
</code></pre><p>Используем в качестве пользователя <code>IdentityUser&lt;int&gt;</code>. Это позволит нам применить встроенные библиотеки Asp.Net для регистрации и входа в систему (Identity). Тип <code>int</code> - это тип первичного ключа. По умолчанию, если использовать просто <code>IdentityUser</code>, типом первичного ключа будет <code>string</code> и будет генерироваться <code>GUID</code>.</p><p>Для товаров в заказе:</p><pre class="cs hljs"><code class="cs" data-origin="<pre><code class=&quot;cs&quot;>[PrimaryKey(nameof(OrderId), nameof(ProductId))] // составной первичный ключ
public class OrderProduct
{
    public int OrderId { get; set; } 

    public int ProductId { get; set; }

    public int Count { get; set; }

    public decimal CurrentPrice { get; set; }

    public Order Order { get; set; } = null!;

    public Product Product { get; set; } = null!;
}
</code></pre>">[PrimaryKey(nameof(OrderId), nameof(ProductId))] <span class="hljs-comment">// составной первичный ключ</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">OrderProduct</span>
{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> OrderId { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; } 

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> ProductId { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> Count { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">decimal</span> CurrentPrice { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }

    <span class="hljs-keyword">public</span> Order Order { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; } = <span class="hljs-keyword">null</span>!;

    <span class="hljs-keyword">public</span> Product Product { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; } = <span class="hljs-keyword">null</span>!;
}
</code></pre><p>Чтобы применить Identity, мы должны создать контекст и унаследовать его от <code>IdentityDbContext</code>. Сперва установите пакет <code>Microsoft.AspNetCore.Identity.EntityFrameworkCore</code>. Далее:</p><ul>
<li>если мы хотим использовать просто пользователя <code>IdentityUser</code>, мы унаследуем от <code>IdentityDbContext&lt;TUser&gt;</code>;</li><li>если мы хотим использовать пользователя <code>IdentityUser&lt;T&gt;</code> или тип, унаследованный от <code>IdentityUser</code>, мы унаследуем контекст от <code>IdentityDbContext&lt;TUser, TRole, TKey&gt;</code> (тип пользователя, тип роли, тип первичных ключей).</li></ul><p>Создадим контекст:</p><pre class="cs hljs"><code class="cs" data-origin="<pre><code class=&quot;cs&quot;>public class ProductsContext :
    IdentityDbContext&amp;lt;IdentityUser&amp;lt;int&amp;gt;, IdentityRole&amp;lt;int&amp;gt;, int&amp;gt;
{

    public ProductsContext(DbContextOptions options) : base(options)
    {
    }

    public DbSet&amp;lt;Category&amp;gt; Categories { get; set; }
    public DbSet&amp;lt;Product&amp;gt; Products { get; set; }
    public DbSet&amp;lt;Order&amp;gt; Orders { get; set; }
    public DbSet&amp;lt;OrderProduct&amp;gt; OrderProducts { get; set; }
}
</code></pre>">public class ProductsContext :
    IdentityDbContext&lt;IdentityUser&lt;int&gt;, IdentityRole&lt;int&gt;, int&gt;
{

    public ProductsContext(DbContextOptions options) : base(options)
    {
    }

    public DbSet&lt;Category&gt; Categories { get; set; }
    public DbSet&lt;Product&gt; Products { get; set; }
    public DbSet&lt;Order&gt; Orders { get; set; }
    public DbSet&lt;OrderProduct&gt; OrderProducts { get; set; }
}
</code></pre><p>Добавим в <code>appsettings</code> строку подключения:</p><pre class="javascript hljs"><code class="js" data-origin="<pre><code class=&quot;js&quot;>&quot;ConnectionStrings&quot;: {
    &quot;sqlite&quot;: &quot;Data Source = products.db&quot;
}
</code></pre>"><span class="hljs-string">"ConnectionStrings"</span>: {
    <span class="hljs-string">"sqlite"</span>: <span class="hljs-string">"Data Source = products.db"</span>
}
</code></pre><p>Внедрим <code>DbContext</code> в контейнер:</p><pre class="cs hljs"><code class="cs" data-origin="<pre><code class=&quot;cs&quot;>string connectionString = builder.Configuration.GetConnectionString(&quot;sqlite&quot;) ?? 
    throw new ApplicationException(&quot;Не задана строка подключения&quot;);
builder.Services.AddDbContext&amp;lt;ProductsContext&amp;gt;(opt =&amp;gt; opt.UseSqlite(connectionString));
</code></pre>"><span class="hljs-keyword">string</span> connectionString = builder.Configuration.GetConnectionString(<span class="hljs-string">"sqlite"</span>) ?? 
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ApplicationException(<span class="hljs-string">"Не задана строка подключения"</span>);
builder.Services.AddDbContext&lt;ProductsContext&gt;(opt =&gt; opt.UseSqlite(connectionString));
</code></pre><p>Выполним миграцию:</p><pre class="powershell hljs"><code class="powershell" data-origin="<pre><code class=&quot;powershell&quot;>Add-Migration &quot;initial&quot;
</code></pre>">Add-Migration <span class="hljs-string">"initial"</span>
</code></pre><p>И обновим БД:</p><pre class="powershell hljs"><code class="powershell" data-origin="<pre><code class=&quot;powershell&quot;>Update-Database
</code></pre>">Update-Database
</code></pre><p>Откройте базу данных программой <code>DBeaver</code> (или другой программой, открывающей Sqlite). Постройте диаграмму. Изучите содержимое таблиц. Обратите внимение на таблицы, которые создает AspNet.</p><h2 id="3.-добавление-аутентификации"><a name="3.-добавление-аутентификации" href="#3.-добавление-аутентификации"></a>3. Добавление аутентификации</h2><p>Установите пакет <code>Microsoft.AspNetCore.Authentication.JwtBearer</code>.</p><p>Добавьте в конвейер <code>app.UseAuthentication();</code>:</p><pre class="cs hljs"><code class="cs" data-origin="<pre><code class=&quot;cs&quot;>app.UseHttpsRedirection();
app.UseAuthentication(); // аутентификация
app.UseAuthorization();
app.MapControllers();
</code></pre>">app.UseHttpsRedirection();
app.UseAuthentication(); <span class="hljs-comment">// аутентификация</span>
app.UseAuthorization();
app.MapControllers();
</code></pre><p>Создайте класс:</p><pre class="cs hljs"><code class="cs" data-origin="<pre><code class=&quot;cs&quot;>public static class KeyProvider
{
    private static string keyString = 
        &quot;super_secret_string_123_poiuytrewqasdfghjklzxcvbnm&quot;; // тут будет секретный ключ
        // хотя вообще, не стоит его оставлять в исходном коде при загрузке в репозитории

    public static byte[] Key =&amp;gt; Encoding.Default.GetBytes(keyString);

}
</code></pre>"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title">KeyProvider</span>
{
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">string</span> keyString = 
        <span class="hljs-string">"super_secret_string_123_poiuytrewqasdfghjklzxcvbnm"</span>; <span class="hljs-comment">// тут будет секретный ключ</span>
        <span class="hljs-comment">// хотя вообще, не стоит его оставлять в исходном коде при загрузке в репозитории</span>

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">byte</span>[] Key =&gt; Encoding.Default.GetBytes(keyString);

}
</code></pre><p>Внедрите зависимость:</p><pre class="cs hljs"><code class="cs" data-origin="<pre><code class=&quot;cs&quot;>builder.Services
    .AddAuthentication(JwtBearerDefaults.AuthenticationScheme)
    .AddJwtBearer(opt =&amp;gt;
    {
        opt.TokenValidationParameters = new TokenValidationParameters
        {
            ValidateIssuer = true, // провереяем издателя
            ValidateAudience = false, // не проверяем аудиторию
            ValidateLifetime = true, // проверяем время жизни
            ValidateIssuerSigningKey = true, // проверяем ключ
            ValidIssuer = &quot;ects&quot;,
            IssuerSigningKey = new SymmetricSecurityKey(KeyProvider.Key)
        };
    });
</code></pre>">builder.Services
    .AddAuthentication(JwtBearerDefaults.AuthenticationScheme)
    .AddJwtBearer(opt =&gt;
    {
        opt.TokenValidationParameters = <span class="hljs-keyword">new</span> TokenValidationParameters
        {
            ValidateIssuer = <span class="hljs-keyword">true</span>, <span class="hljs-comment">// провереяем издателя</span>
            ValidateAudience = <span class="hljs-keyword">false</span>, <span class="hljs-comment">// не проверяем аудиторию</span>
            ValidateLifetime = <span class="hljs-keyword">true</span>, <span class="hljs-comment">// проверяем время жизни</span>
            ValidateIssuerSigningKey = <span class="hljs-keyword">true</span>, <span class="hljs-comment">// проверяем ключ</span>
            ValidIssuer = <span class="hljs-string">"ects"</span>,
            IssuerSigningKey = <span class="hljs-keyword">new</span> SymmetricSecurityKey(KeyProvider.Key)
        };
    });
</code></pre><p>Создайте контроллер <code>ProductsController</code> (Пустой <strong>контроллер API</strong>, <strong>не MVC</strong>):</p><pre class="cs hljs"><code class="cs" data-origin="<pre><code class=&quot;cs&quot;>[Route(&quot;api/[controller]&quot;)]
[ApiController]
public class ProductsController : ControllerBase
{
    [HttpGet]
    public IActionResult GetProducts()
    {
        return Ok(&quot;Success&quot;);
    }
}
</code></pre>">[Route(<span class="hljs-string">"api/[controller]"</span>)]
[ApiController]
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ProductsController</span> : <span class="hljs-title">ControllerBase</span>
{
    [HttpGet]
    <span class="hljs-function"><span class="hljs-keyword">public</span> IActionResult <span class="hljs-title">GetProducts</span><span class="hljs-params">()</span>
    </span>{
        <span class="hljs-keyword">return</span> Ok(<span class="hljs-string">"Success"</span>);
    }
}
</code></pre><p>Запустите приложение и проверьте, что данный метод работает и отдает <code>200 OK</code> с сообщением <code>Success</code>.</p><p>Добавьте аттрибут <code>[Authorize]</code>:</p><pre class="cs hljs"><code class="cs" data-origin="<pre><code class=&quot;cs&quot;>[HttpGet]
[Authorize(AuthenticationSchemes = JwtBearerDefaults.AuthenticationScheme)]
public IActionResult GetProducts()
{
    return Ok(&quot;Success&quot;);
}
</code></pre>">[HttpGet]
[Authorize(AuthenticationSchemes = JwtBearerDefaults.AuthenticationScheme)]
<span class="hljs-function"><span class="hljs-keyword">public</span> IActionResult <span class="hljs-title">GetProducts</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">return</span> Ok(<span class="hljs-string">"Success"</span>);
}
</code></pre><p>Запустите, и убедитесь, что кодом ответа станет <code>401</code>.</p><p>Создайте контроллер <code>UsersController</code> и добавьте в него метод <code>Login</code>:</p><pre class="cs hljs"><code class="cs" data-origin="<pre><code class=&quot;cs&quot;>[HttpGet]
public IActionResult Login()
{
    return Ok(&quot;login&quot;);
}
</code></pre>">[HttpGet]
<span class="hljs-function"><span class="hljs-keyword">public</span> IActionResult <span class="hljs-title">Login</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">return</span> Ok(<span class="hljs-string">"login"</span>);
}
</code></pre><p>Проверьте работоспособность.</p><p>Добавьте еще один метод (см. презентации по JWT и соответствующее руководство):</p><pre class="cs hljs"><code class="cs" data-origin="<pre><code class=&quot;cs&quot;>private string getToken()
{
    // утверждения о пользователе
    List&amp;lt;Claim&amp;gt; claims = new List&amp;lt;Claim&amp;gt;
    {
        new Claim(ClaimTypes.NameIdentifier, &quot;1&quot;), // id
        new Claim(ClaimTypes.Name, &quot;Test&quot;), // name
        new Claim(ClaimTypes.Role, &quot;Client&quot;) // role
    };

    // настройки ключа
    SigningCredentials credentials = new SigningCredentials(
            new SymmetricSecurityKey(KeyProvider.Key), // секретный ключ
            SecurityAlgorithms.HmacSha256); // алгоритм

    // создаем токен
    var token = new JwtSecurityToken(
            issuer: &quot;ects&quot;,
            notBefore: DateTime.Now,
            expires: DateTime.Now.AddHours(12),
            claims: claims,
            signingCredentials: credentials
        );
    // обрабатываем его, получая строку
    var handler = new JwtSecurityTokenHandler();
    string result = handler.WriteToken(token);
    // возвращаем результат
    return result;
}
</code></pre>"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">string</span> <span class="hljs-title">getToken</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-comment">// утверждения о пользователе</span>
    List&lt;Claim&gt; claims = <span class="hljs-keyword">new</span> List&lt;Claim&gt;
    {
        <span class="hljs-keyword">new</span> Claim(ClaimTypes.NameIdentifier, <span class="hljs-string">"1"</span>), <span class="hljs-comment">// id</span>
        <span class="hljs-keyword">new</span> Claim(ClaimTypes.Name, <span class="hljs-string">"Test"</span>), <span class="hljs-comment">// name</span>
        <span class="hljs-keyword">new</span> Claim(ClaimTypes.Role, <span class="hljs-string">"Client"</span>) <span class="hljs-comment">// role</span>
    };

    <span class="hljs-comment">// настройки ключа</span>
    SigningCredentials credentials = <span class="hljs-keyword">new</span> SigningCredentials(
            <span class="hljs-keyword">new</span> SymmetricSecurityKey(KeyProvider.Key), <span class="hljs-comment">// секретный ключ</span>
            SecurityAlgorithms.HmacSha256); <span class="hljs-comment">// алгоритм</span>

    <span class="hljs-comment">// создаем токен</span>
    <span class="hljs-keyword">var</span> token = <span class="hljs-keyword">new</span> JwtSecurityToken(
            issuer: <span class="hljs-string">"ects"</span>,
            notBefore: DateTime.Now,
            expires: DateTime.Now.AddHours(<span class="hljs-number">12</span>),
            claims: claims,
            signingCredentials: credentials
        );
    <span class="hljs-comment">// обрабатываем его, получая строку</span>
    <span class="hljs-keyword">var</span> handler = <span class="hljs-keyword">new</span> JwtSecurityTokenHandler();
    <span class="hljs-keyword">string</span> result = handler.WriteToken(token);
    <span class="hljs-comment">// возвращаем результат</span>
    <span class="hljs-keyword">return</span> result;
}
</code></pre><p>Вызовите его в <code>Login</code>:</p><pre class="cs hljs"><code class="cs" data-origin="<pre><code class=&quot;cs&quot;>[HttpGet]
public IActionResult Login()
{
    return Ok(getToken());
}
</code></pre>">[HttpGet]
<span class="hljs-function"><span class="hljs-keyword">public</span> IActionResult <span class="hljs-title">Login</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">return</span> Ok(getToken());
}
</code></pre><p>Запустите и получите токен. Проверьте его с помощью <a href="https://jwt.io/">https://jwt.io/</a></p><h2 id="4.-регистрация-и-аутентификация"><a name="4.-регистрация-и-аутентификация" href="#4.-регистрация-и-аутентификация"></a>4. Регистрация и аутентификация</h2><p>Добавим зависимость:</p><pre class="cs hljs"><code class="cs" data-origin="<pre><code class=&quot;cs&quot;>builder.Services
    .AddIdentity&amp;lt;IdentityUser&amp;lt;int&amp;gt;, IdentityRole&amp;lt;int&amp;gt;&amp;gt;(opt =&amp;gt; { // добавляем Identity
        // настройки пароля
        opt.Password.RequiredLength = 8;
        opt.Password.RequireDigit = true;
        opt.Password.RequireLowercase = true;
        opt.Password.RequireUppercase = true;
        // настройки email
        opt.User.RequireUniqueEmail = true;
    })
    .AddEntityFrameworkStores&amp;lt;ProductsContext&amp;gt;(); // добавляем для него поддержку EF
</code></pre>">builder.Services
    .AddIdentity&lt;IdentityUser&lt;<span class="hljs-keyword">int</span>&gt;, IdentityRole&lt;<span class="hljs-keyword">int</span>&gt;&gt;(opt =&gt; { <span class="hljs-comment">// добавляем Identity</span>
        <span class="hljs-comment">// настройки пароля</span>
        opt.Password.RequiredLength = <span class="hljs-number">8</span>;
        opt.Password.RequireDigit = <span class="hljs-keyword">true</span>;
        opt.Password.RequireLowercase = <span class="hljs-keyword">true</span>;
        opt.Password.RequireUppercase = <span class="hljs-keyword">true</span>;
        <span class="hljs-comment">// настройки email</span>
        opt.User.RequireUniqueEmail = <span class="hljs-keyword">true</span>;
    })
    .AddEntityFrameworkStores&lt;ProductsContext&gt;(); <span class="hljs-comment">// добавляем для него поддержку EF</span>
</code></pre><p>Внедрите в <code>UsersController</code> зависимости:</p><pre class="cs hljs"><code class="cs" data-origin="<pre><code class=&quot;cs&quot;>private UserManager&amp;lt;IdentityUser&amp;lt;int&amp;gt;&amp;gt; users;
private readonly SignInManager&amp;lt;IdentityUser&amp;lt;int&amp;gt;&amp;gt; signIn;

public UsersController(UserManager&amp;lt;IdentityUser&amp;lt;int&amp;gt;&amp;gt; users, 
    SignInManager&amp;lt;IdentityUser&amp;lt;int&amp;gt;&amp;gt; signIn)
{
    this.users = users;
    this.signIn = signIn;
}
</code></pre>"><span class="hljs-keyword">private</span> UserManager&lt;IdentityUser&lt;<span class="hljs-keyword">int</span>&gt;&gt; users;
<span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> SignInManager&lt;IdentityUser&lt;<span class="hljs-keyword">int</span>&gt;&gt; signIn;

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">UsersController</span><span class="hljs-params">(UserManager&lt;IdentityUser&lt;<span class="hljs-keyword">int</span>&gt;&gt; users, 
    SignInManager&lt;IdentityUser&lt;<span class="hljs-keyword">int</span>&gt;&gt; signIn)</span>
</span>{
    <span class="hljs-keyword">this</span>.users = users;
    <span class="hljs-keyword">this</span>.signIn = signIn;
}
</code></pre><p>Создайте папку <code>DataTransfer</code>. В ней создайте класс:</p><pre class="cs hljs"><code class="cs" data-origin="<pre><code class=&quot;cs&quot;>public class RegistrationDTO
{
    [Required]
    [MinLength(1)]
    public string Username { get; set; } = string.Empty;

    [Required]
    [MinLength(8)]
    public string Password { get; set; } = string.Empty;

    [Required]
    [EmailAddress]
    public string Email { get; set; } = string.Empty;
}
</code></pre>"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">RegistrationDTO</span>
{
    [Required]
    [MinLength(<span class="hljs-number">1</span>)]
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">string</span> Username { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; } = <span class="hljs-keyword">string</span>.Empty;

    [Required]
    [MinLength(<span class="hljs-number">8</span>)]
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">string</span> Password { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; } = <span class="hljs-keyword">string</span>.Empty;

    [Required]
    [EmailAddress]
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">string</span> Email { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; } = <span class="hljs-keyword">string</span>.Empty;
}
</code></pre><p>Добавьте метод регистрации:</p><pre class="cs hljs"><code class="cs" data-origin="<pre><code class=&quot;cs&quot;>[HttpPost(&quot;registration&quot;)]
public async Task&amp;lt;IActionResult&amp;gt; Registration(RegistrationDTO dto)
{
    var user = new IdentityUser&amp;lt;int&amp;gt;
    {
        UserName = dto.Username,
        Email = dto.Email
    };

    // создаем пользователя
    var result = await users.CreateAsync(user, dto.Password);
    // если неудача, то BadRequest
    if (!result.Succeeded)
    {
        return BadRequest(result.Errors);
    }
    // добаляем роль
    result = await users.AddToRoleAsync(user, &quot;client&quot;);
    // если неудача, то BadRequest
    if (!result.Succeeded)
    {
        return BadRequest(result.Errors);
    }

    return Ok(&quot;Success&quot;);
}
</code></pre>">[HttpPost(<span class="hljs-string">"registration"</span>)]
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;IActionResult&gt; <span class="hljs-title">Registration</span><span class="hljs-params">(RegistrationDTO dto)</span>
</span>{
    <span class="hljs-keyword">var</span> user = <span class="hljs-keyword">new</span> IdentityUser&lt;<span class="hljs-keyword">int</span>&gt;
    {
        UserName = dto.Username,
        Email = dto.Email
    };

    <span class="hljs-comment">// создаем пользователя</span>
    <span class="hljs-keyword">var</span> result = <span class="hljs-keyword">await</span> users.CreateAsync(user, dto.Password);
    <span class="hljs-comment">// если неудача, то BadRequest</span>
    <span class="hljs-keyword">if</span> (!result.Succeeded)
    {
        <span class="hljs-keyword">return</span> BadRequest(result.Errors);
    }
    <span class="hljs-comment">// добаляем роль</span>
    result = <span class="hljs-keyword">await</span> users.AddToRoleAsync(user, <span class="hljs-string">"client"</span>);
    <span class="hljs-comment">// если неудача, то BadRequest</span>
    <span class="hljs-keyword">if</span> (!result.Succeeded)
    {
        <span class="hljs-keyword">return</span> BadRequest(result.Errors);
    }

    <span class="hljs-keyword">return</span> Ok(<span class="hljs-string">"Success"</span>);
}
</code></pre><p>Добавьте в <code>Program.cs</code> строки для начального посева ролей (после <code>app.Build()</code>):</p><pre class="cs hljs"><code class="cs" data-origin="<pre><code class=&quot;cs&quot;>using (var scope = app.Services.CreateScope())
{
    var roles = scope.ServiceProvider.GetRequiredService&amp;lt;RoleManager&amp;lt;IdentityRole&amp;lt;int&amp;gt;&amp;gt;&amp;gt;();
    if (!roles.Roles.Any())
    {
        await roles!.CreateAsync(new IdentityRole&amp;lt;int&amp;gt; { Name = &quot;admin&quot; });
        await roles!.CreateAsync(new IdentityRole&amp;lt;int&amp;gt; { Name = &quot;client&quot; });
    }
}
</code></pre>"><span class="hljs-keyword">using</span> (<span class="hljs-keyword">var</span> scope = app.Services.CreateScope())
{
    <span class="hljs-keyword">var</span> roles = scope.ServiceProvider.GetRequiredService&lt;RoleManager&lt;IdentityRole&lt;<span class="hljs-keyword">int</span>&gt;&gt;&gt;();
    <span class="hljs-keyword">if</span> (!roles.Roles.Any())
    {
        <span class="hljs-keyword">await</span> roles!.CreateAsync(<span class="hljs-keyword">new</span> IdentityRole&lt;<span class="hljs-keyword">int</span>&gt; { Name = <span class="hljs-string">"admin"</span> });
        <span class="hljs-keyword">await</span> roles!.CreateAsync(<span class="hljs-keyword">new</span> IdentityRole&lt;<span class="hljs-keyword">int</span>&gt; { Name = <span class="hljs-string">"client"</span> });
    }
}
</code></pre><p>Запустите и проверьте регистрацию пользователя. Изучите содержимое таблиц базы данных с помощью DBeaver.</p><p>Создайте в <code>DataTransfer</code> класс:</p><pre class="cs hljs"><code class="cs" data-origin="<pre><code class=&quot;cs&quot;>public class LoginDTO
{
    public string Username { get; set; }
    public string Password { get; set; }

}
</code></pre>"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">LoginDTO</span>
{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">string</span> Username { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">string</span> Password { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }

}
</code></pre><p>Измените метод <code>Login</code>:</p><pre class="cs hljs"><code class="cs" data-origin="<pre><code class=&quot;cs&quot;>[HttpPost(&quot;login&quot;)]
public async Task&amp;lt;IActionResult&amp;gt; Login(LoginDTO loginDto)
{
    var user = await users.FindByNameAsync(loginDto.Username);

    if (user is null)
    {
        return NotFound(&quot;Неверное имя пользователя или пароль&quot;);
    }

    if (!await users.CheckPasswordAsync(user, loginDto.Password))
    {
        return NotFound(&quot;Неверное имя пользователя или пароль&quot;);
    }

    var principal = await signIn.CreateUserPrincipalAsync(user);

    return Ok(getToken(principal));
}
</code></pre>">[HttpPost(<span class="hljs-string">"login"</span>)]
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;IActionResult&gt; <span class="hljs-title">Login</span><span class="hljs-params">(LoginDTO loginDto)</span>
</span>{
    <span class="hljs-keyword">var</span> user = <span class="hljs-keyword">await</span> users.FindByNameAsync(loginDto.Username);

    <span class="hljs-keyword">if</span> (user <span class="hljs-keyword">is</span> <span class="hljs-keyword">null</span>)
    {
        <span class="hljs-keyword">return</span> NotFound(<span class="hljs-string">"Неверное имя пользователя или пароль"</span>);
    }

    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">await</span> users.CheckPasswordAsync(user, loginDto.Password))
    {
        <span class="hljs-keyword">return</span> NotFound(<span class="hljs-string">"Неверное имя пользователя или пароль"</span>);
    }

    <span class="hljs-keyword">var</span> principal = <span class="hljs-keyword">await</span> signIn.CreateUserPrincipalAsync(user);

    <span class="hljs-keyword">return</span> Ok(getToken(principal));
}
</code></pre><p>И <code>getToken</code>:</p><pre class="cs hljs"><code class="cs" data-origin="<pre><code class=&quot;cs&quot;>private string getToken(ClaimsPrincipal principal)
{
   // утверждения о пользователе
   List&amp;lt;Claim&amp;gt; claims = principal.Claims.ToList();

   // настройки ключа
   SigningCredentials credentials = new SigningCredentials(
           new SymmetricSecurityKey(KeyProvider.Key), // секретный ключ
           SecurityAlgorithms.HmacSha256); // алгоритм

   // создаем токен
   var token = new JwtSecurityToken(
           issuer: &quot;ects&quot;,
           notBefore: DateTime.Now,
           expires: DateTime.Now.AddHours(12),
           claims: claims,
           signingCredentials: credentials
       );
   // обрабатываем его, получая строку
   var handler = new JwtSecurityTokenHandler();
   string result = handler.WriteToken(token);
   // возвращаем результат
   return result;
}
</code></pre>"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">string</span> <span class="hljs-title">getToken</span><span class="hljs-params">(ClaimsPrincipal principal)</span>
</span>{
   <span class="hljs-comment">// утверждения о пользователе</span>
   List&lt;Claim&gt; claims = principal.Claims.ToList();

   <span class="hljs-comment">// настройки ключа</span>
   SigningCredentials credentials = <span class="hljs-keyword">new</span> SigningCredentials(
           <span class="hljs-keyword">new</span> SymmetricSecurityKey(KeyProvider.Key), <span class="hljs-comment">// секретный ключ</span>
           SecurityAlgorithms.HmacSha256); <span class="hljs-comment">// алгоритм</span>

   <span class="hljs-comment">// создаем токен</span>
   <span class="hljs-keyword">var</span> token = <span class="hljs-keyword">new</span> JwtSecurityToken(
           issuer: <span class="hljs-string">"ects"</span>,
           notBefore: DateTime.Now,
           expires: DateTime.Now.AddHours(<span class="hljs-number">12</span>),
           claims: claims,
           signingCredentials: credentials
       );
   <span class="hljs-comment">// обрабатываем его, получая строку</span>
   <span class="hljs-keyword">var</span> handler = <span class="hljs-keyword">new</span> JwtSecurityTokenHandler();
   <span class="hljs-keyword">string</span> result = handler.WriteToken(token);
   <span class="hljs-comment">// возвращаем результат</span>
   <span class="hljs-keyword">return</span> result;
}
</code></pre><p>Запустите, авторизуйтесь и проверьте токен с помощью jwt.io.</p><h2 id="5.-поддержка-аутентификации-в-swagger"><a name="5.-поддержка-аутентификации-в-swagger" href="#5.-поддержка-аутентификации-в-swagger"></a>5. Поддержка аутентификации в Swagger</h2><p>Вы можете проделать это <em>опционально</em>. Или отказаться от выполнения данного пункта и использовать для отправки запросов Postman.</p><p>Добавим поддержку аутентификации в Swagger для упрощения отладки и тестирования.<br>Для этого, согласно документации, следует просто изменить <code>builder.Services.AddSwaggerGen()</code> на:</p><pre class="cs hljs"><code class="cs" data-origin="<pre><code class=&quot;cs&quot;>builder.Services.AddSwaggerGen(options =&amp;gt;
{
    options.AddSecurityDefinition(&quot;Bearer&quot;, new OpenApiSecurityScheme
    {
        In = ParameterLocation.Header,
        Description = &quot;Please enter a valid token&quot;,
        Name = &quot;Authorization&quot;,
        Type = SecuritySchemeType.Http,
        BearerFormat = &quot;JWT&quot;,
        Scheme = &quot;Bearer&quot;
    });
    options.AddSecurityRequirement(new OpenApiSecurityRequirement
    {
        {
            new OpenApiSecurityScheme
            {
                Reference = new OpenApiReference
                {
                    Type=ReferenceType.SecurityScheme,
                    Id=&quot;Bearer&quot;
                }
            },
            new string[]{}
        }
    });
})
</code></pre>">builder.Services.AddSwaggerGen(options =&gt;
{
    options.AddSecurityDefinition(<span class="hljs-string">"Bearer"</span>, <span class="hljs-keyword">new</span> OpenApiSecurityScheme
    {
        In = ParameterLocation.Header,
        Description = <span class="hljs-string">"Please enter a valid token"</span>,
        Name = <span class="hljs-string">"Authorization"</span>,
        Type = SecuritySchemeType.Http,
        BearerFormat = <span class="hljs-string">"JWT"</span>,
        Scheme = <span class="hljs-string">"Bearer"</span>
    });
    options.AddSecurityRequirement(<span class="hljs-keyword">new</span> OpenApiSecurityRequirement
    {
        {
            <span class="hljs-keyword">new</span> OpenApiSecurityScheme
            {
                Reference = <span class="hljs-keyword">new</span> OpenApiReference
                {
                    Type=ReferenceType.SecurityScheme,
                    Id=<span class="hljs-string">"Bearer"</span>
                }
            },
            <span class="hljs-keyword">new</span> <span class="hljs-keyword">string</span>[]{}
        }
    });
})
</code></pre><h2 id="6.-список-категорий"><a name="6.-список-категорий" href="#6.-список-категорий"></a>6. Список категорий</h2><p>Обратитесь к защищенному методу (<code>GetProducts</code>) с использованием токена (успех, 200) и без него (неудача, 401).</p><p>Зарегистрируйте еще одного пользователя и добавьте ему роль <code>admin</code> через базу данных (см. таблицу <code>AspNetUserRoles</code>).</p><p>Добавьте шаблонный элемент:<br><img src="1.png" alt=""><br><img src="2.png" alt=""></p><p>Добавьте для методов добавления, изменения и удаления аттрибут:</p><pre class="cs hljs"><code class="cs" data-origin="<pre><code class=&quot;cs&quot;>[Authorize(AuthenticationSchemes = JwtBearerDefaults.AuthenticationScheme,
    Roles = &quot;admin&quot;)]
</code></pre>">[Authorize(AuthenticationSchemes = JwtBearerDefaults.AuthenticationScheme,
    Roles = <span class="hljs-string">"admin"</span>)]
</code></pre><p>Запустите и протестируйте методы:</p><ul>
<li>без токена (недоступно);</li><li>с токеном клиента (недоступно, 403);</li><li>с токеном администратора (доступно);</li></ul><p>Добавьте “лишнюю” категорию. Измените ее. Удалите ее.</p><p>Добавьте категории “Бургеры”, “Напитки”, “Закуски”, “Десерты”.</p><h2 id="7.-список-продуктов"><a name="7.-список-продуктов" href="#7.-список-продуктов"></a>7. Список продуктов</h2><p>Добавьте в <code>ProductsController</code> <code>DbContext</code>:</p><pre class="cs hljs"><code class="cs" data-origin="<pre><code class=&quot;cs&quot;>private ProductsContext context;

public ProductsController(ProductsContext context)
{
    this.context = context;
}
</code></pre>"><span class="hljs-keyword">private</span> ProductsContext context;

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ProductsController</span><span class="hljs-params">(ProductsContext context)</span>
</span>{
    <span class="hljs-keyword">this</span>.context = context;
}
</code></pre><p>Измените метод <code>GetProducts</code>:</p><pre class="cs hljs"><code class="cs" data-origin="<pre><code class=&quot;cs&quot;>[HttpGet]
public async Task&amp;lt;List&amp;lt;Product&amp;gt;&amp;gt; GetProducts()
{
    return await context.Products.Include(p =&amp;gt; p.Category).ToListAsync();
}
</code></pre>">[HttpGet]
<span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;List&lt;Product&gt;&gt; GetProducts()
{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> context.Products.Include(p =&gt; p.Category).ToListAsync();
}
</code></pre><p>Добавьте в <code>DataTransfer</code> класс <code>UpdateProductDTO</code>:</p><pre class="cs hljs"><code class="cs" data-origin="<pre><code class=&quot;cs&quot;>public class UpdateProductDTO
{
    [StringLength(100)]
    public string Name { get; set; } = string.Empty;

    public string? Description { get; set; } = string.Empty;

    [Required]
    public decimal Price { get; set; }

    [Required]
    public int CategoryId { get; set; }

    public Product ToProduct()
    {
        return new Product
        {
            Name = Name,
            Description = Description,
            Price = Price,
            CategoryId = CategoryId
        };
    }
}
</code></pre>"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">UpdateProductDTO</span>
{
    [StringLength(<span class="hljs-number">100</span>)]
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">string</span> Name { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; } = <span class="hljs-keyword">string</span>.Empty;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">string</span>? Description { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; } = <span class="hljs-keyword">string</span>.Empty;

    [Required]
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">decimal</span> Price { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }

    [Required]
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> CategoryId { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }

    <span class="hljs-function"><span class="hljs-keyword">public</span> Product <span class="hljs-title">ToProduct</span><span class="hljs-params">()</span>
    </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Product
        {
            Name = Name,
            Description = Description,
            Price = Price,
            CategoryId = CategoryId
        };
    }
}
</code></pre><p>Метод добавления:</p><pre class="cs hljs"><code class="cs" data-origin="<pre><code class=&quot;cs&quot;>[HttpPost(&quot;add&quot;)]
public async Task&amp;lt;IActionResult&amp;gt; AddProduct(UpdateProductDTO productDTO)
{
    if (!context.Categories.Any(c =&amp;gt; c.CategoryId == productDTO.CategoryId))
    {
        return BadRequest(&quot;Invalid Category&quot;);
    }
    var product = productDTO.ToProduct();
    context.Products.Add(product);
    await context.SaveChangesAsync();
    return Ok(product);
}
</code></pre>">[HttpPost(<span class="hljs-string">"add"</span>)]
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;IActionResult&gt; <span class="hljs-title">AddProduct</span><span class="hljs-params">(UpdateProductDTO productDTO)</span>
</span>{
    <span class="hljs-keyword">if</span> (!context.Categories.Any(c =&gt; c.CategoryId == productDTO.CategoryId))
    {
        <span class="hljs-keyword">return</span> BadRequest(<span class="hljs-string">"Invalid Category"</span>);
    }
    <span class="hljs-keyword">var</span> product = productDTO.ToProduct();
    context.Products.Add(product);
    <span class="hljs-keyword">await</span> context.SaveChangesAsync();
    <span class="hljs-keyword">return</span> Ok(product);
}
</code></pre><p>Метод изменения:</p><pre class="cs hljs"><code class="cs" data-origin="<pre><code class=&quot;cs&quot;>[HttpPut(&quot;update/{id}&quot;)]
public async Task&amp;lt;IActionResult&amp;gt; UpdateProduct(UpdateProductDTO productDTO, int id)
{
    if (!context.Categories.Any(c =&amp;gt; c.CategoryId == productDTO.CategoryId))
    {
        return BadRequest(&quot;Invalid Category&quot;);
    }
    var product = context.Products.Find(id);
    if (product is null)
    {
        return NotFound();
    }
    product.Name = productDTO.Name;
    product.Price = productDTO.Price;
    product.CategoryId = productDTO.CategoryId;
    product.Description = productDTO.Description;
    await context.SaveChangesAsync();
    return Ok(product);
}
</code></pre>">[HttpPut(<span class="hljs-string">"update/{id}"</span>)]
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;IActionResult&gt; <span class="hljs-title">UpdateProduct</span><span class="hljs-params">(UpdateProductDTO productDTO, <span class="hljs-keyword">int</span> id)</span>
</span>{
    <span class="hljs-keyword">if</span> (!context.Categories.Any(c =&gt; c.CategoryId == productDTO.CategoryId))
    {
        <span class="hljs-keyword">return</span> BadRequest(<span class="hljs-string">"Invalid Category"</span>);
    }
    <span class="hljs-keyword">var</span> product = context.Products.Find(id);
    <span class="hljs-keyword">if</span> (product <span class="hljs-keyword">is</span> <span class="hljs-keyword">null</span>)
    {
        <span class="hljs-keyword">return</span> NotFound();
    }
    product.Name = productDTO.Name;
    product.Price = productDTO.Price;
    product.CategoryId = productDTO.CategoryId;
    product.Description = productDTO.Description;
    <span class="hljs-keyword">await</span> context.SaveChangesAsync();
    <span class="hljs-keyword">return</span> Ok(product);
}
</code></pre><p>Запустите и проверьте работоспособность. Добавьте <code>Authorize</code>, чтобы запретить действия не администраторам системы.<br>Самостоятельно реализуйте метод для вывода всех товаров указанной категории <code>/products/category/{id}</code><br>Самостоятельно реализуйте метод удаления <code>/products/delete/{id}</code> и защитите его с помощью <code>Authorize</code>.</p><h2 id="8.-загрузка-изображения"><a name="8.-загрузка-изображения" href="#8.-загрузка-изображения"></a>8. Загрузка изображения</h2><p>Добавьте middleware:</p><pre class="cs hljs"><code class="cs" data-origin="<pre><code class=&quot;cs&quot;>app.UseStaticFiles();
</code></pre>">app.UseStaticFiles();
</code></pre><p>Создайте каталог <code>wwwroot</code>. В нем создайте каталог <code>images</code>.</p><p>Добавьте в <code>ProductsController</code> метод:</p><pre class="cs hljs"><code class="cs" data-origin="<pre><code class=&quot;cs&quot;>[HttpPut(&quot;update/photo/{id}&quot;)]
public async Task&amp;lt;IActionResult&amp;gt; SetPhoto(int id, [FromForm]IFormFile file)
{

}
</code></pre>">[HttpPut(<span class="hljs-string">"update/photo/{id}"</span>)]
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;IActionResult&gt; <span class="hljs-title">SetPhoto</span><span class="hljs-params">(<span class="hljs-keyword">int</span> id, [FromForm]IFormFile file)</span>
</span>{

}
</code></pre><p>Скачайте пакет <code>SixLabors.ImageSharp</code> для работы с изображениями.</p><p>Реализуйте <code>SetPhoto</code>:</p><pre class="cs hljs"><code class="cs" data-origin="<pre><code class=&quot;cs&quot;>[HttpPut(&quot;update/photo/{id}&quot;)]
public async Task&amp;lt;IActionResult&amp;gt; SetPhoto(int id, [FromForm]IFormFile file)
{
    var product = context.Products.Find(id);
    if (product is null)
    {
        return NotFound();
    }

    if (file.Length &amp;gt; 2 * 1024 * 1024)
    {
        return BadRequest(&quot;Max image size is 2MB&quot;);
    }

    MemoryStream stream = new();
    try
    {
        await file.CopyToAsync(stream);
        var format = Image.DetectFormat(stream.ToArray());
        if (format.DefaultMimeType != &quot;image/png&quot;)
        {
            return BadRequest(&quot;Invalid file format&quot;);
        }
    }
    catch (UnknownImageFormatException)
    {
        return BadRequest(&quot;Invalid file format&quot;);
    }
    finally
    {
        stream.Close();
    }

    return Ok();
}
</code></pre>">[HttpPut(<span class="hljs-string">"update/photo/{id}"</span>)]
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;IActionResult&gt; <span class="hljs-title">SetPhoto</span><span class="hljs-params">(<span class="hljs-keyword">int</span> id, [FromForm]IFormFile file)</span>
</span>{
    <span class="hljs-keyword">var</span> product = context.Products.Find(id);
    <span class="hljs-keyword">if</span> (product <span class="hljs-keyword">is</span> <span class="hljs-keyword">null</span>)
    {
        <span class="hljs-keyword">return</span> NotFound();
    }

    <span class="hljs-keyword">if</span> (file.Length &gt; <span class="hljs-number">2</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>)
    {
        <span class="hljs-keyword">return</span> BadRequest(<span class="hljs-string">"Max image size is 2MB"</span>);
    }

    MemoryStream stream = <span class="hljs-keyword">new</span>();
    <span class="hljs-keyword">try</span>
    {
        <span class="hljs-keyword">await</span> file.CopyToAsync(stream);
        <span class="hljs-keyword">var</span> format = Image.DetectFormat(stream.ToArray());
        <span class="hljs-keyword">if</span> (format.DefaultMimeType != <span class="hljs-string">"image/png"</span>)
        {
            <span class="hljs-keyword">return</span> BadRequest(<span class="hljs-string">"Invalid file format"</span>);
        }
    }
    <span class="hljs-keyword">catch</span> (UnknownImageFormatException)
    {
        <span class="hljs-keyword">return</span> BadRequest(<span class="hljs-string">"Invalid file format"</span>);
    }
    <span class="hljs-keyword">finally</span>
    {
        stream.Close();
    }

    <span class="hljs-keyword">return</span> Ok();
}
</code></pre><p>Отправьте различные файлы через Postman, проверьте, что корректно проверяется размер и формат файла.<br><img src="3.png" alt=""></p><p>Внедрите зависимость:</p><pre class="cs hljs"><code class="cs" data-origin="<pre><code class=&quot;cs&quot;>private ProductsContext context;
private readonly IWebHostEnvironment hosting;

public ProductsController(ProductsContext context, IWebHostEnvironment hosting)
{
    this.context = context;
    this.hosting = hosting;
}
</code></pre>"><span class="hljs-keyword">private</span> ProductsContext context;
<span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> IWebHostEnvironment hosting;

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ProductsController</span><span class="hljs-params">(ProductsContext context, IWebHostEnvironment hosting)</span>
</span>{
    <span class="hljs-keyword">this</span>.context = context;
    <span class="hljs-keyword">this</span>.hosting = hosting;
}
</code></pre><p>Модифицируйте метод добавления изображения и проверьте его работоспособность.</p><pre class="cs hljs"><code class="cs" data-origin="<pre><code class=&quot;cs&quot;>[HttpPut(&quot;update/photo/{id}&quot;)]
public async Task&amp;lt;IActionResult&amp;gt; SetPhoto(int id, [FromForm]IFormFile file)
{
    // проверка на существование продукта
    var product = context.Products.Find(id);
    if (product is null)
    {
        return NotFound();
    }
    // проверка размера файла
    if (file.Length &amp;gt; 2 * 1024 * 1024)
    {
        return BadRequest(&quot;Max image size is 2MB&quot;);
    }
    // открываем поток для чтения
    var stream = file.OpenReadStream();
    try
    {
        // проверяем формат файла
        var format = await Image.DetectFormatAsync(stream);
        if (format.DefaultMimeType != &quot;image/png&quot;)
        {
            return BadRequest(&quot;Invalid file format&quot;);
        }
    }
    catch (UnknownImageFormatException)
    {
        return BadRequest(&quot;Invalid file format&quot;);
    }

    // если все правильно, то сохраняем в файл
    string filename = Path.Combine(hosting.WebRootPath, &quot;images&quot;, Path.GetRandomFileName() + &quot;.png&quot;);
    using (FileStream fs = new FileStream(filename, FileMode.Create))
    {
        stream.Position = 0;
        stream.CopyTo(fs);
    }
    // сохраним имя файла в БД
    product.Photo = Path.GetFileName(filename);
    context.SaveChanges();
    return Ok();

}
</code></pre>">[HttpPut(<span class="hljs-string">"update/photo/{id}"</span>)]
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;IActionResult&gt; <span class="hljs-title">SetPhoto</span><span class="hljs-params">(<span class="hljs-keyword">int</span> id, [FromForm]IFormFile file)</span>
</span>{
    <span class="hljs-comment">// проверка на существование продукта</span>
    <span class="hljs-keyword">var</span> product = context.Products.Find(id);
    <span class="hljs-keyword">if</span> (product <span class="hljs-keyword">is</span> <span class="hljs-keyword">null</span>)
    {
        <span class="hljs-keyword">return</span> NotFound();
    }
    <span class="hljs-comment">// проверка размера файла</span>
    <span class="hljs-keyword">if</span> (file.Length &gt; <span class="hljs-number">2</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>)
    {
        <span class="hljs-keyword">return</span> BadRequest(<span class="hljs-string">"Max image size is 2MB"</span>);
    }
    <span class="hljs-comment">// открываем поток для чтения</span>
    <span class="hljs-keyword">var</span> stream = file.OpenReadStream();
    <span class="hljs-keyword">try</span>
    {
        <span class="hljs-comment">// проверяем формат файла</span>
        <span class="hljs-keyword">var</span> format = <span class="hljs-keyword">await</span> Image.DetectFormatAsync(stream);
        <span class="hljs-keyword">if</span> (format.DefaultMimeType != <span class="hljs-string">"image/png"</span>)
        {
            <span class="hljs-keyword">return</span> BadRequest(<span class="hljs-string">"Invalid file format"</span>);
        }
    }
    <span class="hljs-keyword">catch</span> (UnknownImageFormatException)
    {
        <span class="hljs-keyword">return</span> BadRequest(<span class="hljs-string">"Invalid file format"</span>);
    }

    <span class="hljs-comment">// если все правильно, то сохраняем в файл</span>
    <span class="hljs-keyword">string</span> filename = Path.Combine(hosting.WebRootPath, <span class="hljs-string">"images"</span>, Path.GetRandomFileName() + <span class="hljs-string">".png"</span>);
    <span class="hljs-keyword">using</span> (FileStream fs = <span class="hljs-keyword">new</span> FileStream(filename, FileMode.Create))
    {
        stream.Position = <span class="hljs-number">0</span>;
        stream.CopyTo(fs);
    }
    <span class="hljs-comment">// сохраним имя файла в БД</span>
    product.Photo = Path.GetFileName(filename);
    context.SaveChanges();
    <span class="hljs-keyword">return</span> Ok();

}
</code></pre><p>Защитите метод с помощью <code>Authorize</code>.</p><p>Добавьте с помощью api несколько товаров и изображений.</p><h2 id="9.-оформление-заказа"><a name="9.-оформление-заказа" href="#9.-оформление-заказа"></a>9. Оформление заказа</h2><p>Создайте контроллер API <code>OrdersController</code>:</p><pre class="cs hljs"><code class="cs" data-origin="<pre><code class=&quot;cs&quot;>private ProductsContext context;
private readonly UserManager&amp;lt;IdentityUser&amp;lt;int&amp;gt;&amp;gt; userManager;

public OrdersController(ProductsContext context, UserManager&amp;lt;IdentityUser&amp;lt;int&amp;gt;&amp;gt; userManager)
{
    this.context = context;
    this.userManager = userManager;
}
</code></pre>"><span class="hljs-keyword">private</span> ProductsContext context;
<span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> UserManager&lt;IdentityUser&lt;<span class="hljs-keyword">int</span>&gt;&gt; userManager;

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">OrdersController</span><span class="hljs-params">(ProductsContext context, UserManager&lt;IdentityUser&lt;<span class="hljs-keyword">int</span>&gt;&gt; userManager)</span>
</span>{
    <span class="hljs-keyword">this</span>.context = context;
    <span class="hljs-keyword">this</span>.userManager = userManager;
}
</code></pre><p>Добавьте в <code>DataTransfer</code> класс:</p><pre class="cs hljs"><code class="cs" data-origin="<pre><code class=&quot;cs&quot;>public class CreateOrderDTO
{
    public class ProductsCount
    {
        public int ProductId { get; set; }

        [Range(1, 30)]
        public int Count { get; set; }
    }

    [Required]
    public string Address { get; set; }

    [Required]
    public List&amp;lt;ProductsCount&amp;gt; Products { get; set; } = new();

}
</code></pre>"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">CreateOrderDTO</span>
{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ProductsCount</span>
    {
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> ProductId { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }

        [Range(<span class="hljs-number">1</span>, <span class="hljs-number">30</span>)]
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> Count { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
    }

    [Required]
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">string</span> Address { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }

    [Required]
    <span class="hljs-keyword">public</span> List&lt;ProductsCount&gt; Products { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; } = <span class="hljs-keyword">new</span>();

}
</code></pre><p>В контроллер <code>OrdersController</code> метод:</p><pre class="cs hljs"><code class="cs" data-origin="<pre><code class=&quot;cs&quot;>[Authorize(AuthenticationSchemes = JwtBearerDefaults.AuthenticationScheme)]
[HttpPost(&quot;create&quot;)]
public async Task&amp;lt;IActionResult&amp;gt; CreateOrder(CreateOrderDTO createDto)
{
    return Ok();
}
</code></pre>">[Authorize(AuthenticationSchemes = JwtBearerDefaults.AuthenticationScheme)]
[HttpPost(<span class="hljs-string">"create"</span>)]
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;IActionResult&gt; <span class="hljs-title">CreateOrder</span><span class="hljs-params">(CreateOrderDTO createDto)</span>
</span>{
    <span class="hljs-keyword">return</span> Ok();
}
</code></pre><p>В методе мы сперва получим Id пользователя из Claims, используя свойство <code>User</code>:</p><pre class="cs hljs"><code class="cs" data-origin="<pre><code class=&quot;cs&quot;>var userId = Convert.ToInt32(User.FindFirstValue(ClaimTypes.NameIdentifier));
</code></pre>"><span class="hljs-keyword">var</span> userId = Convert.ToInt32(User.FindFirstValue(ClaimTypes.NameIdentifier));
</code></pre><p>Проверим, что каждый продукт в заказе встречается один раз:</p><pre class="cs hljs"><code class="cs" data-origin="<pre><code class=&quot;cs&quot;>if (createDto.Products.DistinctBy(p =&amp;gt; p.ProductId).Count() != createDto.Products.Count)
{
    return BadRequest(&quot;Products in order must be unique&quot;);
}
</code></pre>"><span class="hljs-keyword">if</span> (createDto.Products.DistinctBy(p =&gt; p.ProductId).Count() != createDto.Products.Count)
{
    <span class="hljs-keyword">return</span> BadRequest(<span class="hljs-string">"Products in order must be unique"</span>);
}
</code></pre><p>Получим по id продуктов их список:</p><pre class="cs hljs"><code class="cs" data-origin="<pre><code class=&quot;cs&quot;>var products = createDto.Products.Select(p =&amp;gt; context.Products.Find(p.ProductId));
</code></pre>"><span class="hljs-keyword">var</span> products = createDto.Products.Select(p =&gt; context.Products.Find(p.ProductId));
</code></pre><p>Изменим предыдущую строку, получив пару значений: количество и продукт.</p><pre class="cs hljs"><code class="cs" data-origin="<pre><code class=&quot;cs&quot;>var products = createDto.Products.Select(p =&amp;gt; new
{
    Product = context.Products.Find(p.ProductId),
    Count = p.Count
});
</code></pre>"><span class="hljs-keyword">var</span> products = createDto.Products.Select(p =&gt; <span class="hljs-keyword">new</span>
{
    Product = context.Products.Find(p.ProductId),
    Count = p.Count
});
</code></pre><p>Проверим, что по всем Id удалось найти продукт:</p><pre class="cs hljs"><code class="cs" data-origin="<pre><code class=&quot;cs&quot;>if (products.Any(p =&amp;gt; p.Product is null))
{
    return BadRequest(&quot;Invalid product id&quot;);
}
</code></pre>"><span class="hljs-keyword">if</span> (products.Any(p =&gt; p.Product <span class="hljs-keyword">is</span> <span class="hljs-keyword">null</span>))
{
    <span class="hljs-keyword">return</span> BadRequest(<span class="hljs-string">"Invalid product id"</span>);
}
</code></pre><p>Создадим и добавим заказ:</p><pre class="cs hljs"><code class="cs" data-origin="<pre><code class=&quot;cs&quot;>var order = new Order
{
    Address = createDto.Address,
    Time = DateTime.Now,
    UserId = userId
};
context.Orders.Add(order);
</code></pre>"><span class="hljs-keyword">var</span> order = <span class="hljs-keyword">new</span> Order
{
    Address = createDto.Address,
    Time = DateTime.Now,
    UserId = userId
};
context.Orders.Add(order);
</code></pre><p>Добавим записи в <code>OrderProduct</code>:</p><pre class="cs hljs"><code class="cs" data-origin="<pre><code class=&quot;cs&quot;>context.OrderProducts.AddRange(products.Select(p =&amp;gt; new OrderProduct
{
    Count = p.Count,
    CurrentPrice = p.Product!.Price,
    ProductId = p.Product!.ProductId,
    Order = order
}));
</code></pre>">context.OrderProducts.AddRange(products.Select(p =&gt; <span class="hljs-keyword">new</span> OrderProduct
{
    Count = p.Count,
    CurrentPrice = p.Product!.Price,
    ProductId = p.Product!.ProductId,
    Order = order
}));
</code></pre><p>Вызовем <code>SaveChanges</code> для отправки Sql-запросов:</p><pre class="cs hljs"><code class="cs" data-origin="<pre><code class=&quot;cs&quot;>await context.SaveChangesAsync();
</code></pre>"><span class="hljs-keyword">await</span> context.SaveChangesAsync();
</code></pre><p>Проверьте работоспособность. Запустите программу и попробуйте создать заказ.</p><h2 id="10.-история-заказов"><a name="10.-история-заказов" href="#10.-история-заказов"></a>10. История заказов</h2><p>Самостоятельно реализуйте вывод истории заказов.<br>Каждый JSON-объект (заказ) должен включать в себя следующие поля:</p><ul>
<li>id заказа;</li><li>id пользователя;</li><li>адрес;</li><li>время заказа;</li><li>список товаров и их количеств.</li></ul><p>Про каждый товар необходимо вывести:</p><ul>
<li>id товара;</li><li>название товара;</li><li>цена, по которой он был куплен;</li><li>изображение;</li><li>количество;</li></ul><p>Создайте для решения задачи два новых типа <code>OrderInfoDTO</code> и <code>ProductInOrderDTO</code>.</p><p>Примерный результат:</p><pre class="cs hljs"><code class="cs" data-origin="<pre><code class=&quot;cs&quot;>[
  {
    &quot;userId&quot;: 4,
    &quot;orderId&quot;: 0,
    &quot;time&quot;: &quot;2023-11-29T09:11:17.725537&quot;,
    &quot;address&quot;: &quot;Первомайская 73&quot;,
    &quot;products&quot;: [
      {
        &quot;productId&quot;: 1,
        &quot;name&quot;: &quot;test123&quot;,
        &quot;photo&quot;: &quot;photo.png&quot;,
        &quot;price&quot;: 123,
        &quot;count&quot;: 20
      },
      {
        &quot;productId&quot;: 2,
        &quot;name&quot;: &quot;test&quot;,
        &quot;photo&quot;: &quot;&quot;,
        &quot;price&quot;: 500,
        &quot;count&quot;: 10
      }
    ]
  },
  {
    &quot;userId&quot;: 4,
    &quot;orderId&quot;: 0,
    &quot;time&quot;: &quot;2023-11-29T09:11:22.5335924&quot;,
    &quot;address&quot;: &quot;Первомайская 73&quot;,
    &quot;products&quot;: [
      {
        &quot;productId&quot;: 1,
        &quot;name&quot;: &quot;test123&quot;,
        &quot;photo&quot;: &quot;photo.png&quot;,
        &quot;price&quot;: 123,
        &quot;count&quot;: 20
      }
    ]
  },
  {
    &quot;userId&quot;: 4,
    &quot;orderId&quot;: 0,
    &quot;time&quot;: &quot;2023-11-29T09:14:00.4248033&quot;,
    &quot;address&quot;: &quot;Первомайская 73&quot;,
    &quot;products&quot;: [
      {
        &quot;productId&quot;: 1,
        &quot;name&quot;: &quot;test123&quot;,
        &quot;photo&quot;: &quot;photo.png&quot;,
        &quot;price&quot;: 123,
        &quot;count&quot;: 10
      },
      {
        &quot;productId&quot;: 2,
        &quot;name&quot;: &quot;test&quot;,
        &quot;photo&quot;: &quot;&quot;,
        &quot;price&quot;: 500,
        &quot;count&quot;: 20
      }
    ]
  }
]
</code></pre>">[
  {
    <span class="hljs-string">"userId"</span>: <span class="hljs-number">4</span>,
    <span class="hljs-string">"orderId"</span>: <span class="hljs-number">0</span>,
    <span class="hljs-string">"time"</span>: <span class="hljs-string">"2023-11-29T09:11:17.725537"</span>,
    <span class="hljs-string">"address"</span>: <span class="hljs-string">"Первомайская 73"</span>,
    <span class="hljs-string">"products"</span>: [
      {
        <span class="hljs-string">"productId"</span>: <span class="hljs-number">1</span>,
        <span class="hljs-string">"name"</span>: <span class="hljs-string">"test123"</span>,
        <span class="hljs-string">"photo"</span>: <span class="hljs-string">"photo.png"</span>,
        <span class="hljs-string">"price"</span>: <span class="hljs-number">123</span>,
        <span class="hljs-string">"count"</span>: <span class="hljs-number">20</span>
      },
      {
        <span class="hljs-string">"productId"</span>: <span class="hljs-number">2</span>,
        <span class="hljs-string">"name"</span>: <span class="hljs-string">"test"</span>,
        <span class="hljs-string">"photo"</span>: <span class="hljs-string">""</span>,
        <span class="hljs-string">"price"</span>: <span class="hljs-number">500</span>,
        <span class="hljs-string">"count"</span>: <span class="hljs-number">10</span>
      }
    ]
  },
  {
    <span class="hljs-string">"userId"</span>: <span class="hljs-number">4</span>,
    <span class="hljs-string">"orderId"</span>: <span class="hljs-number">0</span>,
    <span class="hljs-string">"time"</span>: <span class="hljs-string">"2023-11-29T09:11:22.5335924"</span>,
    <span class="hljs-string">"address"</span>: <span class="hljs-string">"Первомайская 73"</span>,
    <span class="hljs-string">"products"</span>: [
      {
        <span class="hljs-string">"productId"</span>: <span class="hljs-number">1</span>,
        <span class="hljs-string">"name"</span>: <span class="hljs-string">"test123"</span>,
        <span class="hljs-string">"photo"</span>: <span class="hljs-string">"photo.png"</span>,
        <span class="hljs-string">"price"</span>: <span class="hljs-number">123</span>,
        <span class="hljs-string">"count"</span>: <span class="hljs-number">20</span>
      }
    ]
  },
  {
    <span class="hljs-string">"userId"</span>: <span class="hljs-number">4</span>,
    <span class="hljs-string">"orderId"</span>: <span class="hljs-number">0</span>,
    <span class="hljs-string">"time"</span>: <span class="hljs-string">"2023-11-29T09:14:00.4248033"</span>,
    <span class="hljs-string">"address"</span>: <span class="hljs-string">"Первомайская 73"</span>,
    <span class="hljs-string">"products"</span>: [
      {
        <span class="hljs-string">"productId"</span>: <span class="hljs-number">1</span>,
        <span class="hljs-string">"name"</span>: <span class="hljs-string">"test123"</span>,
        <span class="hljs-string">"photo"</span>: <span class="hljs-string">"photo.png"</span>,
        <span class="hljs-string">"price"</span>: <span class="hljs-number">123</span>,
        <span class="hljs-string">"count"</span>: <span class="hljs-number">10</span>
      },
      {
        <span class="hljs-string">"productId"</span>: <span class="hljs-number">2</span>,
        <span class="hljs-string">"name"</span>: <span class="hljs-string">"test"</span>,
        <span class="hljs-string">"photo"</span>: <span class="hljs-string">""</span>,
        <span class="hljs-string">"price"</span>: <span class="hljs-number">500</span>,
        <span class="hljs-string">"count"</span>: <span class="hljs-number">20</span>
      }
    ]
  }
]
</code></pre><p>Примерный код получения списка <code>OrderInfoDTO</code>:</p><pre class="cs hljs"><code class="cs" data-origin="<pre><code class=&quot;cs&quot;>var orders = context
    .Orders
    .Where(o =&amp;gt; o.UserId == userId)
    .Select(o =&amp;gt; new OrderInfoDTO
    {
        Address = o.Address,
        Time = o.Time,
        UserId = userId,
        Products = context.OrderProducts
            .Include(o =&amp;gt; o.Product)
            .Where(op =&amp;gt; op.OrderId == o.OrderId)
            .Select(op =&amp;gt; new ProductInOrderDTO
            {
                Count = op.Count,
                Name = op.Product.Name,
                Photo = op.Product.Photo,
                Price = op.CurrentPrice,
                ProductId = op.Product.ProductId
            })
            .ToList()
    });
</code></pre>"><span class="hljs-keyword">var</span> orders = context
    .Orders
    .Where(o =&gt; o.UserId == userId)
    .Select(o =&gt; <span class="hljs-keyword">new</span> OrderInfoDTO
    {
        Address = o.Address,
        Time = o.Time,
        UserId = userId,
        Products = context.OrderProducts
            .Include(o =&gt; o.Product)
            .Where(op =&gt; op.OrderId == o.OrderId)
            .Select(op =&gt; <span class="hljs-keyword">new</span> ProductInOrderDTO
            {
                Count = op.Count,
                Name = op.Product.Name,
                Photo = op.Product.Photo,
                Price = op.CurrentPrice,
                ProductId = op.Product.ProductId
            })
            .ToList()
    });
</code></pre><h2 id="11.-разворачивание-приложения"><a name="11.-разворачивание-приложения" href="#11.-разворачивание-приложения"></a>11. Разворачивание приложения</h2><p>Опубликуйте приложение в Docker-контейнер.</p>

<footer style="position:fixed; font-size:.8em; text-align:right; bottom:0px; margin-left:-25px; height:20px; width:100%;">generated by <a href="http://pad.haroopress.com" target="_blank">haroopad</a></footer>
</body>
</html>
